<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5c7cfa">
    <title>UberCalc - App do Douglas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #5c7cfa; 
            --primary-dark: #4b6bf5;
            --bg-body: #f0f2f5;
            --card-bg: #ffffff;
            --text-dark: #333333;
            --text-gray: #6c757d;
            --text-light: #adb5bd;
            --success: #20c997; 
            --danger: #fa5252; 
            --warning: #f59e0b;
            --uber: #212529; 
            --didi: #f59e0b; 
            --border-color: #e9ecef;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
            --radius: 12px;
        }

        /* Modo Escuro (Dark Mode) adaptado para o nosso visual */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --card-bg: #1e293b;
            --text-dark: #f1f5f9;
            --text-gray: #94a3b8;
            --text-light: #64748b;
            --border-color: #334155;
            --uber: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-body); color: var(--text-dark); display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background-color 0.3s; }

        /* HEADER */
        header { background-color: var(--primary); color: white; padding: 16px 24px; font-size: 18px; font-weight: 600; flex-shrink: 0; z-index: 100;}
        .header-flex { display: flex; justify-content: space-between; align-items: center; }

        /* ÁREA PRINCIPAL COM SCROLL */
        main { flex-grow: 1; overflow-y: auto; padding-bottom: 90px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; } 

        /* ABAS */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* HERO SECTION (Tela Hoje) */
        .hero-section { background-color: var(--primary); color: white; text-align: center; padding: 20px 20px 40px 20px; margin: -20px -20px 20px -20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .hero-section i { font-size: 32px; margin-bottom: 10px; }
        .hero-section h1 { font-size: 24px; font-weight: 700; margin-bottom: 5px; }

        /* CARTÕES */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); position: relative;}
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .card-header h3 { font-size: 16px; color: var(--text-dark); font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card-title-sm { font-size: 13px; color: var(--text-gray); font-weight: 500; display: flex; align-items: center; gap: 6px; margin-bottom: 8px;}
        .card-value { font-size: 24px; font-weight: 700; }
        
        /* UTILIDADES DE TEXTO */
        .text-success { color: var(--success) !important; }
        .text-danger { color: var(--danger) !important; }
        .text-primary { color: var(--primary) !important; }
        .text-warning { color: var(--warning) !important; }

        /* GRID SYSTEM */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (max-width: 600px) { .grid-mobile-1 { grid-template-columns: 1fr !important; } }

        /* FORMULÁRIOS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; color: var(--text-gray); margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; background: var(--card-bg); color: var(--text-dark); transition: border 0.2s; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); outline: none; }
        
        .btn { width: 100%; padding: 16px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:hover { background-color: var(--primary-dark); }
        .btn-sm { padding: 8px 16px; width: auto; font-size: 13px; }
        .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--primary); }

        /* LISTA HISTÓRICO (Estilo Nosso + Dados do Outro) */
        .history-item { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border-color); box-shadow: var(--shadow); cursor: pointer; }
        .history-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed var(--border-color); padding-bottom: 12px; }
        .history-date { font-weight: 600; color: var(--text-dark); font-size: 15px; }
        .history-badge { padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 14px; }
        .badge-positive { background: rgba(32, 201, 151, 0.1); color: var(--success); }
        .badge-negative { background: rgba(250, 82, 82, 0.1); color: var(--danger); }
        .history-stats { display: flex; justify-content: space-between; text-align: center; }
        .stat-col { flex: 1; }
        .stat-label { font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px;}
        .stat-val { font-size: 14px; font-weight: 600; }

        /* SEGMENTED CONTROL (Relatórios) */
        .segmented-control { display: flex; background: var(--border-color); border-radius: 8px; padding: 4px; margin-bottom: 20px; overflow-x: auto; scrollbar-width: none;}
        .segment { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600; color: var(--text-gray); cursor: pointer; border-radius: 6px; transition: all 0.2s; white-space: nowrap; min-width: 80px;}
        .segment.active { background: var(--card-bg); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .report-section { display: none; }
        .report-section.active { display: block; animation: fadeIn 0.3s; }

        /* MANUTENÇÃO ITENS */
        .maint-category h4 { color: var(--text-gray); font-size: 12px; text-transform: uppercase; margin: 15px 0 10px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;}
        .maint-item { background: var(--card-bg); border-left: 3px solid var(--primary); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-top: 1px solid var(--border-color); border-right: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;}
        .maint-item.danger { border-left-color: var(--danger); }
        .maint-item.warning { border-left-color: var(--warning); }
        .maint-status { font-size: 11px; padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .status-ok { background: rgba(32, 201, 151, 0.1); color: var(--success); }
        .status-warn { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .status-danger { background: rgba(250, 82, 82, 0.1); color: var(--danger); }

        /* CONFIGS */
        .theme-option { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color); cursor: pointer; }
        .theme-option.active { border-color: var(--primary); background: rgba(92, 124, 250, 0.05); }

        /* TOAST E MODAL */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--text-dark); color: var(--card-bg); padding: 12px 24px; border-radius: 24px; font-size: 14px; font-weight: 500; z-index: 2000; opacity: 0; transition: all 0.3s; box-shadow: var(--shadow); white-space: nowrap;}
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); color: white;}

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; align-items: flex-end; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-body); padding: 20px; border-radius: 20px 20px 0 0; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* BOTTOM NAV */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: center; padding-bottom: env(safe-area-inset-bottom); z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-container { display: flex; max-width: 800px; width: 100%; justify-content: space-between; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: var(--text-gray); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px; position: relative;}
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 12px; font-weight: 500; }
        .nav-item.active { color: var(--primary); }
        
        .alert-dot { position: absolute; top: 8px; right: 25%; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; display: none; }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="header-flex">
            <span id="header-title">Hoje</span>
            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 14px; opacity: 0.7;" onclick="exportData()" title="Exportar Backup"></i>
        </div>
    </header>

    <main>
        <div class="container">
            
            <section id="tab-hoje" class="tab-content active">
                <div class="hero-section">
                    <i class="fa-solid fa-car"></i>
                    <h1>UberCalc</h1>
                </div>

                <div class="grid-2">
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-title-sm"><i class="fa-solid fa-gauge text-primary"></i> KM Rodados</div>
                        <div class="card-value text-primary" id="today-km">0 km</div>
                    </div>
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-title-sm"><i class="fa-solid fa-money-bill-wave text-success"></i> Ganhos</div>
                        <div class="card-value text-success" id="today-income">R$ 0,00</div>
                    </div>
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-title-sm"><i class="fa-solid fa-gas-pump text-danger"></i> Gastos</div>
                        <div class="card-value text-danger" id="today-expenses">R$ 0,00</div>
                    </div>
                    <div class="card" style="margin-bottom: 0;">
                        <div class="card-title-sm"><i class="fa-solid fa-wallet text-success"></i> Lucro</div>
                        <div class="card-value text-success" id="today-profit">R$ 0,00</div>
                        <div id="savings-reminder" style="font-size: 11px; color: var(--primary); margin-top: 6px; font-weight: bold; display: none;">
                            Guardar: <span id="savings-amount">R$ 0,00</span> (<span id="savings-percent">10</span>%)
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3><i class="fa-solid fa-clipboard-list text-primary"></i> Lançar Registro</h3>
                    </div>
                    <form id="form-registro" onsubmit="return salvarRegistro(event)">
                        <div class="grid-2 grid-mobile-1">
                            <div class="form-group">
                                <label>Data *</label>
                                <input type="date" id="input-date" required>
                            </div>
                            <div class="form-group">
                                <label>KM do Turno/Dia *</label>
                                <input type="number" inputmode="decimal" id="input-km" placeholder="Ex: 150" step="0.1" required>
                            </div>
                        </div>

                        <div style="font-size: 12px; font-weight: bold; color: var(--text-gray); margin: 10px 0; text-transform: uppercase;">Entradas (R$)</div>
                        <div class="grid-2 grid-mobile-1">
                            <div class="form-group">
                                <label>Uber</label>
                                <input type="number" inputmode="decimal" id="input-uber" placeholder="0,00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>99</label>
                                <input type="number" inputmode="decimal" id="input-99" placeholder="0,00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Outros (Particular/Ifood)</label>
                                <input type="number" inputmode="decimal" id="input-other-income" placeholder="0,00" step="0.01">
                            </div>
                        </div>

                        <div style="font-size: 12px; font-weight: bold; color: var(--text-gray); margin: 10px 0; text-transform: uppercase;">Saídas (R$)</div>
                        <div class="grid-2 grid-mobile-1">
                            <div class="form-group">
                                <label>Combustível</label>
                                <input type="number" inputmode="decimal" id="input-fuel" placeholder="0,00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Alimentação/Outros</label>
                                <input type="number" inputmode="decimal" id="input-other-expense" placeholder="0,00" step="0.01">
                            </div>
                        </div>
                        <button type="submit" class="btn" id="btn-save"><i class="fa-solid fa-floppy-disk"></i> Salvar Registro</button>
                    </form>
                </div>
            </section>

            <section id="tab-historico" class="tab-content">
                <div class="card" style="background: transparent; box-shadow: none; border: none; padding: 0;">
                    <h2 style="font-size: 20px; color: var(--text-dark); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-regular fa-calendar-days text-primary"></i> Todos os Registros
                    </h2>
                    
                    <div id="history-list">
                        </div>
                </div>
            </section>

            <section id="tab-relatorios" class="tab-content">
                <div class="segmented-control">
                    <div class="segment active" onclick="showReport('diario', this)">Resumo Diário</div>
                    <div class="segment" onclick="showReport('semanal', this)">Semanal</div>
                    <div class="segment" onclick="showReport('mensal', this)">Mensal</div>
                    <div class="segment" onclick="showReport('analise', this)">Métricas</div>
                </div>

                <div id="report-diario" class="report-section active">
                    <div id="report-diario-content"></div>
                </div>
                <div id="report-semanal" class="report-section">
                    <div id="report-semanal-content"></div>
                </div>
                <div id="report-mensal" class="report-section">
                    <div id="report-mensal-content"></div>
                </div>
                <div id="report-analise" class="report-section">
                    <div id="report-analise-content"></div>
                </div>
            </section>

            <section id="tab-manutencao" class="tab-content">
                <div class="card" style="border: 2px solid var(--primary); background: rgba(92, 124, 250, 0.05);">
                    <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
                        <div>
                            <div class="card-title-sm"><i class="fa-solid fa-piggy-bank text-primary" style="font-size: 18px;"></i> Saldo Virtual da Reserva</div>
                            <div class="card-value text-primary" id="reserva-total">R$ 0,00</div>
                            <div style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">Calculado com base em todo o histórico de lucros.</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-gray); display: flex; align-items: center; gap: 8px;"><i class="fa-solid fa-car-side text-primary"></i> KM do Veículo:</span>
                    <span style="font-weight: 700; font-size: 16px;" id="vehicle-current-km">0 km</span>
                </div>

                <div id="maintenance-alerts"></div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px 0;">
                    <h3 style="font-size: 16px; display: flex; align-items: center; gap: 8px;"><i class="fa-solid fa-wrench"></i> Peças e Serviços</h3>
                    <button class="btn btn-sm" onclick="showAddMaintenanceModal()"><i class="fa-solid fa-plus"></i> Novo</button>
                </div>

                <div id="maintenance-list">
                    <div class="maint-category"><h4>Óleo e Filtros</h4><div id="oil-maintenance"></div></div>
                    <div class="maint-category"><h4>Freios e Pneus</h4><div id="general-maintenance"></div></div>
                    <div class="maint-category"><h4>Outros Filtros</h4><div id="air-maintenance"></div><div id="fuel-maintenance"></div><div id="cabin-maintenance"></div></div>
                </div>
            </section>

            <section id="tab-config" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fa-solid fa-sliders text-primary"></i> Ajustes do App</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Tema de Cores</label>
                        <div class="theme-option" id="theme-light" onclick="setTheme('light')">
                            <div><strong>Claro</strong><br><small>Visual padrão e limpo</small></div>
                            <i class="fa-solid fa-check text-primary check-icon" id="check-light" style="display:none"></i>
                        </div>
                        <div class="theme-option" id="theme-dark" onclick="setTheme('dark')">
                            <div><strong>Escuro</strong><br><small>Melhor para dirigir à noite</small></div>
                            <i class="fa-solid fa-check text-primary check-icon" id="check-dark" style="display:none"></i>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 25px;">
                        <label>Porcentagem de Reserva (%)</label>
                        <input type="number" id="config-percentage" min="0" max="100" value="10">
                        <small style="color: var(--text-gray);">Define quanto do lucro diário vai para manutenção.</small>
                    </div>

                    <div class="form-group" style="margin-top: 25px;">
                        <label>KM Atual do Painel (Odômetro Mestre)</label>
                        <input type="number" id="config-km" min="0" value="0">
                    </div>

                    <button class="btn" onclick="salvarConfig()" style="margin-top: 20px;"><i class="fa-solid fa-floppy-disk"></i> Salvar Configurações</button>
                </div>

                <div class="card" style="display: flex; gap: 15px; align-items: center; border-color: var(--danger);">
                    <div style="background: rgba(250, 82, 82, 0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--danger);">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div style="flex: 1;">
                        <strong style="display: block; font-size: 15px; color: var(--danger);">Zona de Risco</strong>
                        <span style="font-size: 12px; color: var(--text-gray);">Apagar histórico completo</span>
                    </div>
                    <button class="btn btn-sm" style="background: var(--danger);" onclick="resetAllData()">Apagar</button>
                </div>
            </section>

        </div>
    </main>

    <nav>
        <div class="nav-container">
            <div class="nav-item active" onclick="showTab('hoje', 'Hoje', this)">
                <i class="fa-solid fa-house"></i>
                <span>Hoje</span>
            </div>
            <div class="nav-item" onclick="showTab('historico', 'Histórico', this)">
                <i class="fa-regular fa-calendar-days"></i>
                <span>Histórico</span>
            </div>
            <div class="nav-item" onclick="showTab('relatorios', 'Relatórios', this)">
                <i class="fa-solid fa-chart-simple"></i>
                <span>Relatórios</span>
            </div>
            <div class="nav-item" onclick="showTab('manutencao', 'Manutenção', this)">
                <div class="alert-dot" id="nav-maint-alert"></div>
                <i class="fa-solid fa-wrench"></i>
                <span>Mecânica</span>
            </div>
            <div class="nav-item" onclick="showTab('config', 'Configurações', this)">
                <i class="fa-solid fa-gear"></i>
                <span>Configs</span>
            </div>
        </div>
    </nav>

    <div id="maintenance-modal" class="modal" onclick="if(event.target === this) closeMaintenanceModal()">
        <div class="modal-content card">
            <div class="card-header">
                <h3>Novo Serviço/Peça</h3>
                <i class="fa-solid fa-xmark" style="font-size: 20px; color: var(--text-gray); cursor: pointer;" onclick="closeMaintenanceModal()"></i>
            </div>
            <form id="form-maintenance" onsubmit="return saveMaintenance(event)">
                <div class="form-group">
                    <label>Tipo de Serviço</label>
                    <select id="maint-type" required>
                        <option value="">Selecione...</option>
                        <option value="oil_change">Troca de Óleo do Motor</option>
                        <option value="oil_filter">Filtro de Óleo</option>
                        <option value="air_filter">Filtro de Ar</option>
                        <option value="cabin_filter">Filtro do Ar Cond. (Cabine)</option>
                        <option value="fuel_filter">Filtro de Combustível</option>
                        <option value="brake_pads">Pastilhas de Freio</option>
                        <option value="tires">Troca de Pneus</option>
                        <option value="alignment">Alinhamento/Balanceamento</option>
                        <option value="general">Outro Serviço Geral</option>
                    </select>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="maint-date" required>
                    </div>
                    <div class="form-group">
                        <label>Custo (R$)</label>
                        <input type="number" id="maint-cost" step="0.01" placeholder="0,00">
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>KM da Troca</label>
                        <input type="number" id="maint-km" required>
                    </div>
                    <div class="form-group">
                        <label>Próxima Troca (KM)</label>
                        <input type="number" id="maint-next-km" required>
                    </div>
                </div>
                <button type="submit" class="btn"><i class="fa-solid fa-check"></i> Salvar Manutenção</button>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // CONFIGURAÇÕES BASE E BANCO DE DADOS (LOCALSTORAGE)
        const defaultConfig = { savingsPercentage: 10, totalVehicleKm: 0, theme: 'light', alertKm: 500 };
        let appData = { records: [], maintenance: [], config: { ...defaultConfig } };

        document.addEventListener('DOMContentLoaded', () => { initApp(); });

        function initApp() {
            loadData();
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
            applyTheme();
            loadTodayData();
            calculateVirtualReserve();
        }

        function loadData() {
            const saved = localStorage.getItem('ubercalc_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                appData = { records: parsed.records || [], maintenance: parsed.maintenance || [], config: { ...defaultConfig, ...(parsed.config || {}) } };
            }
        }

        function saveData() { localStorage.setItem('ubercalc_v3', JSON.stringify(appData)); }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // FUNÇÕES DE UI E NAVEGAÇÃO
        function showTab(tabName, title, element) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            if (element) element.classList.add('active');
            if (title) document.getElementById('header-title').innerText = title;

            if(tabName === 'hoje') loadTodayData();
            if(tabName === 'historico') loadHistory();
            if(tabName === 'relatorios') loadReports();
            if(tabName === 'manutencao') loadMaintenance();
            if(tabName === 'config') loadSettings();
        }

        function applyTheme() {
            const theme = appData.config.theme || 'light';
            if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
            else document.documentElement.removeAttribute('data-theme');
            
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.check-icon').forEach(el => el.style.display = 'none');
            const opt = document.getElementById('theme-' + theme);
            if(opt) { opt.classList.add('active'); document.getElementById('check-' + theme).style.display = 'block'; }
        }

        function setTheme(t) { appData.config.theme = t; applyTheme(); saveData(); }

        // MÁSCARAS E FORMATAÇÃO
        const fMoney = (v) => 'R$ ' + (parseFloat(v) || 0).toFixed(2).replace('.', ',');
        const fNum = (v) => (parseFloat(v) || 0).toLocaleString('pt-BR');
        const fDate = (d) => { const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }

        // CALCULAR RESERVA GLOBAL
        function calculateVirtualReserve() {
            let totalLucro = appData.records.reduce((sum, r) => sum + r.profit, 0);
            let guardado = totalLucro * (appData.config.savingsPercentage / 100);
            let totalGastoManut = appData.maintenance.reduce((sum, m) => sum + (m.cost || 0), 0);
            let saldo = guardado - totalGastoManut;
            const el = document.getElementById('reserva-total');
            if(el) {
                el.textContent = fMoney(saldo);
                el.className = 'card-value ' + (saldo >= 0 ? 'text-primary' : 'text-danger');
            }
        }

        // LÓGICA DA ABA: HOJE
        function loadTodayData() {
            const today = new Date().toISOString().split('T')[0];
            const record = appData.records.find(r => r.date === today);
            
            if (record) {
                document.getElementById('today-km').textContent = fNum(record.km) + ' km';
                document.getElementById('today-income').textContent = fMoney(record.total_income);
                document.getElementById('today-expenses').textContent = fMoney(record.total_expenses);
                document.getElementById('today-profit').textContent = fMoney(record.profit);
                
                const savingsAmount = record.profit * (appData.config.savingsPercentage / 100);
                if (savingsAmount > 0) {
                    document.getElementById('savings-reminder').style.display = 'block';
                    document.getElementById('savings-amount').textContent = fMoney(savingsAmount);
                    document.getElementById('savings-percent').textContent = appData.config.savingsPercentage;
                } else { document.getElementById('savings-reminder').style.display = 'none'; }
            } else {
                document.getElementById('today-km').textContent = '0 km';
                document.getElementById('today-income').textContent = 'R$ 0,00';
                document.getElementById('today-expenses').textContent = 'R$ 0,00';
                document.getElementById('today-profit').textContent = 'R$ 0,00';
                document.getElementById('savings-reminder').style.display = 'none';
            }
            calculateVirtualReserve();
        }

        function salvarRegistro(e) {
            e.preventDefault();
            const date = document.getElementById('input-date').value;
            const km = parseFloat(document.getElementById('input-km').value) || 0;
            const uber = parseFloat(document.getElementById('input-uber').value) || 0;
            const n99 = parseFloat(document.getElementById('input-99').value) || 0;
            const otherIncome = parseFloat(document.getElementById('input-other-income').value) || 0;
            const fuel = parseFloat(document.getElementById('input-fuel').value) || 0;
            const otherExpense = parseFloat(document.getElementById('input-other-expense').value) || 0;

            const totalIncome = uber + n99 + otherIncome;
            const totalExpenses = fuel + otherExpense;
            const record = { date, km, uber, n99, other_income: otherIncome, fuel, other_expense: otherExpense, total_income: totalIncome, total_expenses: totalExpenses, profit: totalIncome - totalExpenses };

            const idx = appData.records.findIndex(r => r.date === date);
            if (idx >= 0) { appData.records[idx] = record; showToast('Registro atualizado!'); } 
            else { appData.records.push(record); showToast('Salvo com sucesso!'); }

            if (km > 0 && appData.records.length > 0) {
               // Atualiza o painel mestre somando os KMs lançados, se quiser lógica incremental. 
               // Para ficar fiel ao print, ele lança KM do dia.
               appData.config.totalVehicleKm += km;
            }

            saveData();
            loadTodayData();
            
            // Limpa form exceto data
            ['input-km','input-uber','input-99','input-other-income','input-fuel','input-other-expense'].forEach(id => document.getElementById(id).value = '');
        }

        // LÓGICA DA ABA: HISTÓRICO
        function loadHistory() {
            const container = document.getElementById('history-list');
            if (appData.records.length === 0) { container.innerHTML = '<p style="text-align:center; color: var(--text-gray); padding: 30px;">Nenhum registro ainda.</p>'; return; }
            
            const sorted = [...appData.records].sort((a, b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = sorted.map(r => `
                <div class="history-item" onclick="loadRecordForEdit('${r.date}')">
                    <div class="history-top">
                        <div class="history-date"><i class="fa-regular fa-calendar text-primary"></i> ${fDate(r.date)}</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div class="history-badge ${r.profit >= 0 ? 'badge-positive' : 'badge-negative'}">${fMoney(r.profit)}</div>
                            <i class="fa-solid fa-trash text-danger" style="padding: 5px;" onclick="event.stopPropagation(); deleteRecord('${r.date}')"></i>
                        </div>
                    </div>
                    <div class="history-stats">
                        <div class="stat-col">
                            <div class="stat-label"><i class="fa-solid fa-gauge text-primary"></i> KM</div>
                            <div class="stat-val text-dark">${fNum(r.km)}</div>
                        </div>
                        <div class="stat-col">
                            <div class="stat-label"><i class="fa-solid fa-money-bill-wave text-success"></i> Ganhos</div>
                            <div class="stat-val text-success">${fMoney(r.total_income)}</div>
                        </div>
                        <div class="stat-col">
                            <div class="stat-label"><i class="fa-solid fa-gas-pump text-danger"></i> Gastos</div>
                            <div class="stat-val text-danger">${fMoney(r.total_expenses)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadRecordForEdit(date) {
            const r = appData.records.find(x => x.date === date);
            if(!r) return;
            document.getElementById('input-date').value = r.date;
            document.getElementById('input-km').value = r.km;
            document.getElementById('input-uber').value = r.uber || '';
            document.getElementById('input-99').value = r.n99 || '';
            document.getElementById('input-other-income').value = r.other_income || '';
            document.getElementById('input-fuel').value = r.fuel || '';
            document.getElementById('input-other-expense').value = r.other_expense || '';
            showTab('hoje', 'Editar Registro', document.querySelector('.nav-item'));
            showToast('Dados carregados no formulário', 'success');
        }

        function deleteRecord(date) {
            if(confirm('Tem certeza que deseja apagar o dia ' + fDate(date) + '?')) {
                appData.records = appData.records.filter(r => r.date !== date);
                saveData(); loadHistory(); calculateVirtualReserve(); showToast('Excluído');
            }
        }

        // LÓGICA DA ABA: RELATÓRIOS
        function showReport(type, el) {
            document.querySelectorAll('.segment').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
            document.getElementById('report-' + type).classList.add('active');
            loadReports();
        }

        function loadReports() {
            loadReportDiario();
            loadReportSemanal();
            loadReportMensal();
            loadReportAnalise();
        }

        function loadReportDiario() {
            const container = document.getElementById('report-diario-content');
            const today = new Date().toISOString().split('T')[0];
            const record = appData.records.find(r => r.date === today);

            if (!record) {
                container.innerHTML = `<div class="card" style="text-align:center; padding: 40px;"><i class="fa-regular fa-calendar-xmark text-gray" style="font-size: 40px; margin-bottom: 15px;"></i><p style="color: var(--text-gray);">Nenhum registro para hoje.</p></div>`;
                return;
            }

            container.innerHTML = `
                <div class="card">
                    <div class="card-title-sm"><i class="fa-regular fa-calendar text-primary"></i> ${fDate(record.date)}</div>
                    <div class="grid-2" style="margin-top: 15px;">
                        <div style="text-align: center; padding: 15px; background: rgba(92, 124, 250, 0.05); border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 5px;">KM Rodados</div>
                            <div class="text-primary" style="font-size: 20px; font-weight: 700;">${fNum(record.km)} km</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(32, 201, 151, 0.05); border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 5px;">Lucro do Dia</div>
                            <div class="${record.profit >= 0 ? 'text-success' : 'text-danger'}" style="font-size: 20px; font-weight: 700;">${fMoney(record.profit)}</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title-sm"><i class="fa-solid fa-arrow-down text-success"></i> Entradas</div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <span>Uber</span><span style="font-weight: 600;">${fMoney(record.uber || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <span>99</span><span style="font-weight: 600;">${fMoney(record.n99 || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <span>Outros</span><span style="font-weight: 600;">${fMoney(record.other_income || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; font-weight: bold;">
                        <span>Total Entradas</span><span class="text-success">${fMoney(record.total_income)}</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title-sm"><i class="fa-solid fa-arrow-up text-danger"></i> Saídas</div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <span>Combustível</span><span style="font-weight: 600;">${fMoney(record.fuel || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                        <span>Alimentação/Outros</span><span style="font-weight: 600;">${fMoney(record.other_expense || 0)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; font-weight: bold;">
                        <span>Total Saídas</span><span class="text-danger">${fMoney(record.total_expenses)}</span>
                    </div>
                </div>
            `;
        }

        function loadReportSemanal() {
            const container = document.getElementById('report-semanal-content');
            if (appData.records.length === 0) {
                container.innerHTML = `<div class="card" style="text-align:center; padding: 40px;"><i class="fa-regular fa-calendar-xmark text-gray" style="font-size: 40px; margin-bottom: 15px;"></i><p style="color: var(--text-gray);">Nenhum registro encontrado.</p></div>`;
                return;
            }

            // Agrupar por semana (ISO week)
            const weeks = {};
            appData.records.forEach(r => {
                const d = new Date(r.date);
                const weekKey = getWeekKey(d);
                if (!weeks[weekKey]) weeks[weekKey] = { records: [], km: 0, income: 0, expenses: 0 };
                weeks[weekKey].records.push(r);
                weeks[weekKey].km += r.km;
                weeks[weekKey].income += r.total_income;
                weeks[weekKey].expenses += r.total_expenses;
            });

            const sortedWeeks = Object.keys(weeks).sort().reverse();
            
            container.innerHTML = sortedWeeks.map(weekKey => {
                const w = weeks[weekKey];
                const profit = w.income - w.expenses;
                const [year, week] = weekKey.split('-W');
                return `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fa-solid fa-calendar-week text-primary"></i> Semana ${week}/${year}</h3>
                            <span class="history-badge ${profit >= 0 ? 'badge-positive' : 'badge-negative'}">${fMoney(profit)}</span>
                        </div>
                        <div class="history-stats" style="margin-top: 10px;">
                            <div class="stat-col">
                                <div class="stat-label"><i class="fa-solid fa-car text-primary"></i> Dias</div>
                                <div class="stat-val">${w.records.length}</div>
                            </div>
                            <div class="stat-col">
                                <div class="stat-label"><i class="fa-solid fa-gauge text-primary"></i> KM</div>
                                <div class="stat-val">${fNum(w.km)}</div>
                            </div>
                            <div class="stat-col">
                                <div class="stat-label"><i class="fa-solid fa-money-bill-wave text-success"></i> Ganhos</div>
                                <div class="stat-val text-success">${fMoney(w.income)}</div>
                            </div>
                            <div class="stat-col">
                                <div class="stat-label"><i class="fa-solid fa-gas-pump text-danger"></i> Gastos</div>
                                <div class="stat-val text-danger">${fMoney(w.expenses)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getWeekKey(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function loadReportMensal() {
            const container = document.getElementById('report-mensal-content');
            if (appData.records.length === 0) {
                container.innerHTML = `<div class="card" style="text-align:center; padding: 40px;"><i class="fa-regular fa-calendar-xmark text-gray" style="font-size: 40px; margin-bottom: 15px;"></i><p style="color: var(--text-gray);">Nenhum registro encontrado.</p></div>`;
                return;
            }

            // Agrupar por mês
            const months = {};
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            appData.records.forEach(r => {
                const [year, month] = r.date.split('-');
                const key = `${year}-${month}`;
                if (!months[key]) months[key] = { year, month, records: [], km: 0, income: 0, expenses: 0, uber: 0, n99: 0, other: 0, fuel: 0 };
                months[key].records.push(r);
                months[key].km += r.km;
                months[key].income += r.total_income;
                months[key].expenses += r.total_expenses;
                months[key].uber += r.uber || 0;
                months[key].n99 += r.n99 || 0;
                months[key].other += r.other_income || 0;
                months[key].fuel += r.fuel || 0;
            });

            const sortedMonths = Object.keys(months).sort().reverse();
            
            container.innerHTML = sortedMonths.map(key => {
                const m = months[key];
                const profit = m.income - m.expenses;
                const monthName = monthNames[parseInt(m.month) - 1];
                const avgPerDay = m.records.length > 0 ? profit / m.records.length : 0;
                const rPorKM = m.km > 0 ? profit / m.km : 0;

                return `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fa-regular fa-calendar text-primary"></i> ${monthName} ${m.year}</h3>
                            <span class="history-badge ${profit >= 0 ? 'badge-positive' : 'badge-negative'}">${fMoney(profit)}</span>
                        </div>
                        
                        <div class="grid-2" style="margin: 15px 0; gap: 10px;">
                            <div style="text-align: center; padding: 12px; background: rgba(92, 124, 250, 0.05); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--text-gray);">Dias Trabalhados</div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--text-dark);">${m.records.length}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(92, 124, 250, 0.05); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--text-gray);">KM Total</div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--text-dark);">${fNum(m.km)}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(32, 201, 151, 0.05); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--text-gray);">Média/Dia</div>
                                <div style="font-size: 18px; font-weight: 700;" class="text-success">${fMoney(avgPerDay)}</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(92, 124, 250, 0.05); border-radius: 8px;">
                                <div style="font-size: 11px; color: var(--text-gray);">R$/KM</div>
                                <div style="font-size: 18px; font-weight: 700;" class="text-primary">${fMoney(rPorKM)}</div>
                            </div>
                        </div>

                        <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--text-gray); margin-bottom: 10px;">DETALHAMENTO</div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span>Uber</span><span style="font-weight: 600;">${fMoney(m.uber)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span>99</span><span style="font-weight: 600;">${fMoney(m.n99)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span>Outros</span><span style="font-weight: 600;">${fMoney(m.other)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span class="text-success"><strong>Total Entradas</strong></span><span class="text-success" style="font-weight: 700;">${fMoney(m.income)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                <span>Combustível</span><span style="font-weight: 600;">${fMoney(m.fuel)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span class="text-danger"><strong>Total Saídas</strong></span><span class="text-danger" style="font-weight: 700;">${fMoney(m.expenses)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadReportAnalise() {
            const totalRec = appData.records.length;
            if(totalRec === 0) { 
                document.getElementById('report-analise-content').innerHTML = `<div class="card" style="text-align:center; padding: 40px;"><i class="fa-solid fa-chart-simple text-gray" style="font-size: 40px; margin-bottom: 15px;"></i><p style="color: var(--text-gray);">Sem dados para análise.</p></div>`; 
                return; 
            }
            
            let tKM=0, tInc=0, tExp=0, tUber=0, t99=0, tOther=0;
            appData.records.forEach(r => { 
                tKM+=r.km; 
                tInc+=r.total_income; 
                tExp+=r.total_expenses;
                tUber += r.uber || 0;
                t99 += r.n99 || 0;
                tOther += r.other_income || 0;
            });
            const tProf = tInc - tExp;
            const rPorKM = tKM > 0 ? (tProf / tKM) : 0;
            const margem = tInc > 0 ? (tProf / tInc) * 100 : 0;
            const mediaKmDia = tKM / totalRec;
            const mediaProfDia = tProf / totalRec;

            // Percentuais por plataforma
            const pUber = tInc > 0 ? (tUber / tInc) * 100 : 0;
            const p99 = tInc > 0 ? (t99 / tInc) * 100 : 0;
            const pOther = tInc > 0 ? (tOther / tInc) * 100 : 0;

            document.getElementById('report-analise-content').innerHTML = `
                <div class="card">
                    <div class="card-title-sm"><i class="fa-solid fa-chart-line text-primary"></i> Eficiência Global</div>
                    <div class="grid-2" style="margin-top: 15px; text-align: center;">
                        <div style="padding: 15px; background: rgba(92, 124, 250, 0.05); border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 5px;">R$ por KM (Lucro)</div>
                            <div class="text-primary" style="font-size: 22px; font-weight: 700;">${fMoney(rPorKM)}</div>
                        </div>
                        <div style="padding: 15px; background: rgba(32, 201, 151, 0.05); border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 5px;">Margem Média</div>
                            <div class="text-success" style="font-size: 22px; font-weight: 700;">${fNum(margem)}%</div>
                        </div>
                        <div style="padding: 15px; background: rgba(92, 124, 250, 0.05); border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 5px;">Média KM/Dia</div>
                            <div class="text-primary" style="font-size: 22px; font-weight: 700;">${fNum(mediaKmDia)}</div>
                        </div>
                        <div style="padding: 15px; background: rgba(32, 201, 151, 0.05); border-radius: 8px;">
                            <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 5px;">Média Lucro/Dia</div>
                            <div class="text-success" style="font-size: 22px; font-weight: 700;">${fMoney(mediaProfDia)}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title-sm"><i class="fa-solid fa-chart-pie text-primary"></i> Receita por Plataforma</div>
                    <div style="margin-top: 15px;">
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600;">Uber</span>
                                <span>${fNum(pUber)}%</span>
                            </div>
                            <div style="background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #000; height: 100%; width: ${pUber}%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600;">99</span>
                                <span>${fNum(p99)}%</span>
                            </div>
                            <div style="background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: var(--warning); height: 100%; width: ${p99}%; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600;">Outros</span>
                                <span>${fNum(pOther)}%</span>
                            </div>
                            <div style="background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: var(--primary); height: 100%; width: ${pOther}%; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title-sm"><i class="fa-solid fa-scale-balanced text-primary"></i> Balanço Total (${totalRec} dias)</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                        <span>Entradas</span><span class="text-success" style="font-weight:bold">${fMoney(tInc)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                        <span>Saídas</span><span class="text-danger" style="font-weight:bold">${fMoney(tExp)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 18px;">
                        <strong>Lucro Líquido</strong><strong class="${tProf>=0?'text-success':'text-danger'}">${fMoney(tProf)}</strong>
                    </div>
                </div>
            `;
        }

        // LÓGICA DA ABA: MANUTENÇÃO
        const maintTypesInfo = { oil_change: 'oil', oil_filter: 'oil', air_filter: 'air', cabin_filter: 'air', fuel_filter: 'air', brake_pads: 'general', tires: 'general', alignment: 'general', general: 'general' };

        function loadMaintenance() {
            document.getElementById('vehicle-current-km').textContent = fNum(appData.config.totalVehicleKm) + ' km';
            ['oil-maintenance', 'general-maintenance', 'air-maintenance', 'fuel-maintenance', 'cabin-maintenance'].forEach(id => {
                const el = document.getElementById(id); if(el) el.innerHTML = '';
            });

            let hasAlert = false;
            let alertsHtml = '';

            appData.maintenance.forEach(m => {
                const catId = maintTypesInfo[m.type] + '-maintenance';
                const container = document.getElementById(catId);
                if(!container) return;

                const kmFaltantes = m.nextKm - appData.config.totalVehicleKm;
                let sClass = 'ok', sBadge = 'status-ok', sText = `Faltam ${fNum(kmFaltantes)} km`;

                if (kmFaltantes <= 0) { sClass = 'danger'; sBadge = 'status-danger'; sText = `ATRASADO ${fNum(Math.abs(kmFaltantes))} km`; hasAlert = true; alertsHtml += `<div class="card" style="border-color:var(--danger); background: rgba(250, 82, 82, 0.05); padding: 10px;"><i class="fa-solid fa-triangle-exclamation text-danger"></i> <strong>Atenção:</strong> Serviço atrasado!</div>`;}
                else if (kmFaltantes <= appData.config.alertKm) { sClass = 'warning'; sBadge = 'status-warn'; sText = `Próximo: ${fNum(kmFaltantes)} km`; hasAlert = true; }

                container.insertAdjacentHTML('beforeend', `
                    <div class="maint-item ${sClass}">
                        <div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${m.type.replace('_',' ').toUpperCase()}</div>
                            <div style="font-size: 11px; color: var(--text-gray);">Última troca: ${fNum(m.km)} km (${fDate(m.date)})</div>
                            <div style="margin-top: 6px;"><span class="maint-status ${sBadge}">${sText}</span></div>
                        </div>
                        <i class="fa-solid fa-trash text-danger" style="padding: 10px; cursor: pointer;" onclick="deleteMaintenance('${m.id}')"></i>
                    </div>
                `);
            });

            document.getElementById('maintenance-alerts').innerHTML = alertsHtml;
            document.getElementById('nav-maint-alert').style.display = hasAlert ? 'block' : 'none';
        }

        function showAddMaintenanceModal() {
            document.getElementById('maint-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('maint-km').value = appData.config.totalVehicleKm;
            document.getElementById('maintenance-modal').classList.add('show');
        }
        function closeMaintenanceModal() { document.getElementById('maintenance-modal').classList.remove('show'); document.getElementById('form-maintenance').reset(); }

        function saveMaintenance(e) {
            e.preventDefault();
            const m = {
                id: Date.now().toString(),
                type: document.getElementById('maint-type').value,
                date: document.getElementById('maint-date').value,
                km: parseInt(document.getElementById('maint-km').value) || 0,
                nextKm: parseInt(document.getElementById('maint-next-km').value) || 0,
                cost: parseFloat(document.getElementById('maint-cost').value) || 0
            };
            if (m.nextKm <= m.km) { showToast('Próxima troca deve ser maior que KM atual', 'error'); return false; }
            
            appData.maintenance.push(m);
            if (m.km > appData.config.totalVehicleKm) appData.config.totalVehicleKm = m.km;
            
            saveData(); closeMaintenanceModal(); loadMaintenance(); calculateVirtualReserve(); showToast('Peça/Serviço salvo!');
            return false;
        }

        function deleteMaintenance(id) {
            if(confirm('Excluir registro desta manutenção?')) {
                appData.maintenance = appData.maintenance.filter(x => x.id !== id);
                saveData(); loadMaintenance(); calculateVirtualReserve(); showToast('Excluído');
            }
        }

        // LÓGICA DA ABA: CONFIGS E EXPORTAÇÃO
        function loadSettings() {
            document.getElementById('config-percentage').value = appData.config.savingsPercentage;
            document.getElementById('config-km').value = appData.config.totalVehicleKm;
        }

        function salvarConfig() {
            appData.config.savingsPercentage = parseFloat(document.getElementById('config-percentage').value) || 10;
            appData.config.totalVehicleKm = parseInt(document.getElementById('config-km').value) || 0;
            saveData(); showToast('Configurações salvas!'); loadTodayData();
        }

        function resetAllData() {
            if(confirm('Atenção: Isso vai apagar todo o seu histórico financeiro e de manutenção. Confirma?')) {
                appData = { records: [], maintenance: [], config: { ...defaultConfig } };
                saveData(); showToast('Dados apagados com sucesso.', 'success'); window.location.reload();
            }
        }

        function exportData() {
            if (appData.records.length === 0) return showToast('Sem dados para exportar', 'error');
            const csv = ['Data,KM,Uber,99,Outros,Combustivel,Gastos,Lucro\n' + appData.records.map(r => `${r.date},${r.km},${r.uber},${r.n99},${r.other_income},${r.fuel},${r.other_expense},${r.profit}`).join('\n')];
            const blob = new Blob(csv, { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ubercalc_backup.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast('Backup por CSV gerado!');
        }
    </script>
</body>
</html>